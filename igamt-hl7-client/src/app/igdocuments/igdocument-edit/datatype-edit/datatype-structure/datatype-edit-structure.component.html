<div *ngIf="datatypeStructure">
  <form #editForm="ngForm">
    <div class="ui-g cp-header">
      <div class="ui-g-8 ui-g-nopad">
        <div class="cp-header-title ui-g-12">
          Data Type Structure: {{datatypeStructure.label}}
        </div>
        <div class="ui-g-12 cp-header-subtitle">
                    <span class="ig-list-date" *ngIf="datatypeStructure.updateDate">
                        <i class="fa fa-calendar"></i> {{datatypeStructure.updateDate}}
                    </span>
        </div>
      </div>
      <div class="ui-g-4">
        <button  style="float:right" (click)="save()"  pButton type="button" label="save" class="green-btn" icon="fa fa-floppy-o" [disabled]="editForm.invalid || changeItems.length === 0"></button>
        <button  style="float:right" (click)="reset()" pButton type="button" label="reset" class="red-btn" icon="fa fa-refresh" [disabled]="!editForm.dirty" ></button>
      </div>
    </div>
    <p-treeTable [value]="datatypeStructure.structure" [scrollable]="true" [reorderableColumns]="true" [columns]="selectedColumns" [style]="{width:'100%'}">
      <ng-template pTemplate="caption">
        <div style="text-align:right">
          <p-multiSelect name="select" [options]="cols" [(ngModel)]="selectedColumns" optionLabel="header" (onChange)="reorderCols()" selectedItemsLabel="{0} columns selected" [style]="{minWidth: '200px'}" defaultLabel="Choose Columns"></p-multiSelect>
        </div>
      </ng-template>

      <ng-template pTemplate="colgroup" let-columns>
        <colgroup>
          <col *ngFor="let col of columns" class="{{col.style}}">
        </colgroup>
      </ng-template>

      <ng-template pTemplate="header" let-columns>
        <tr>
          <th *ngFor="let col of columns">
            {{col.header}}

          </th>



        </tr>
      </ng-template>

      <ng-template pTemplate="body"  let-node="node" let-rowNode let-rowData="rowData" let-columns="columns">
        <tr>
          <td *ngFor="let col of columns; let i = index" [ngSwitch]="col.field">
            <ng-container *ngSwitchCase="'name'">
              <i (click)="print(node);print(changeItems);"><name-col [type]="node.data.type" [rowNode]="rowNode" [index] = "i" [position]="node.data.position" [description]="node.data.name"></name-col></i>
            </ng-container>

            <ng-container *ngSwitchCase="'usage'">
              <usage-col *ngIf="node.data.type === 'COMPONENT'" [(usage)]="node.data.usage" [(bindings)]="node.data.bindings" [(changeItems)] = "changeItems" [idPath]="node.data.idPath" [viewScope]="node.data.viewScope" [sourceId]="datatypeStructure.id"></usage-col>
              <usage-readonly-col *ngIf="node.data.type !== 'COMPONENT'" [usage]="node.data.usage" [bindings]="node.data.bindings" [idPath]="node.data.idPath"></usage-readonly-col>
            </ng-container>

            <ng-container *ngSwitchCase="'cardinality'">
              <cardinality-col *ngIf="node.data.type === 'COMPONENT'" [(min)]="node.data.min" [(max)]="node.data.max" [idPath]="node.data.idPath" [(changeItems)]="changeItems"></cardinality-col>
            </ng-container>

            <ng-container *ngSwitchCase="'length'">
              <length-col *ngIf="node.data.type === 'COMPONENT'"  [(minLength)]="node.data.minLength" [(maxLength)]="node.data.maxLength" [(confLength)]="node.data.confLength" [idPath]="node.data.idPath" [leaf]="node.data.datatypeLabel.leaf" [(changeItems)]="changeItems"></length-col>
              <length-readonly-col *ngIf="node.data.type !== 'COMPONENT'" [minLength]="node.data.minLength" [maxLength]="node.data.maxLength" [leaf]="node.data.datatypeLabel.leaf"></length-readonly-col>
            </ng-container>

            <ng-container *ngSwitchCase="'confLength'">
              <conflength-col *ngIf="node.data.type === 'COMPONENT'" [(minLength)]="node.data.minLength" [(maxLength)]="node.data.maxLength" [(confLength)]="node.data.confLength" [idPath]="node.data.idPath" [leaf]="node.data.datatypeLabel.leaf" [(changeItems)]="changeItems"></conflength-col>
              <conflength-readonly-col *ngIf="node.data.type !== 'COMPONENT'" [confLength]="node.data.confLength" [leaf]="node.data.datatypeLabel.leaf"></conflength-readonly-col>
            </ng-container>

            <ng-container *ngSwitchCase="'datatype'">
              <datatype-col *ngIf="node.data.type === 'COMPONENT'" [(ref)]="node.data.ref" (refresh)="refreshTree()" [(datatypeLabel)]="node.data.datatypeLabel" [idPath]="node.data.idPath" [path]="node.data.path" [documentId] ="igId" [viewScope]="node.data.viewScope" [(children)]="node.children" [(changeItems)]="changeItems" [documentType]="documentType"></datatype-col>
              <datatype-readonly-col *ngIf="node.data.type !== 'COMPONENT'" [ref]="node.data.ref" [datatypeLabel]="node.data.datatypeLabel" [documentType]="documentType" ></datatype-readonly-col>
            </ng-container>

            <ng-container *ngSwitchCase="'valueSet'">
              <valueset-col *ngIf="configService.isValueSetAllow(node.data.datatypeLabel.name, node.data.position, node.parent, datatypeStructure.name, node.data.type)" [datatypeLabel]="node.data.datatypeLabel" [igId] = "igId" [(bindings)]="node.data.bindings" [idPath]="node.data.idPath" [sourceId]= "datatypeStructure.id" [viewScope]="node.data.viewScope" [(changeItems)]="changeItems"></valueset-col>
            </ng-container>

            <ng-container *ngSwitchCase="'singleCode'">
              <singlecode-col *ngIf="configService.isSingleCodeAllow(node.data.datatypeLabel.name, node.data.position, node.parent, datatypeStructure.name, node.data.type,node.data.datatypeLabel.leaf, node.data.bindings)" [(bindings)]="node.data.bindings" [idPath]="node.data.idPath" [sourceId]= "datatypeStructure.id" [viewScope]="node.data.viewScope" [(changeItems)]="changeItems"></singlecode-col>
            </ng-container>

            <ng-container *ngSwitchCase="'constantValue'">
              <constantvalue-col *ngIf="configService.isConstantValueAllow(node.data.datatypeLabel.name, node.data.position, node.parent, datatypeStructure.name, node.data.type,node.data.datatypeLabel.leaf)" [(bindings)]="node.data.bindings" [idPath]="node.data.idPath" [sourceId]= "datatypeStructure.id" [viewScope]="node.data.viewScope" [(changeItems)]="changeItems"></constantvalue-col>
            </ng-container>

            <ng-container *ngSwitchCase="'textDef'">
              <textdef-col *ngIf="node.data.type === 'COMPONENT'" [(text)]="node.data.text" [(changeItems)] = "changeItems" [idPath]="node.data.idPath"></textdef-col>
              <textdef-readonly-col *ngIf="node.data.type !== 'COMPONENT'" [text]="node.data.text"></textdef-readonly-col>
            </ng-container>

            <ng-container *ngSwitchCase="'comment'">
              <comment-col [(bindings)]="node.data.bindings" [idPath]="node.data.idPath" [sourceId]= "datatypeStructure.id" [viewScope]="node.data.viewScope" [(changeItems)]="changeItems"></comment-col>
            </ng-container>
          </td>
        </tr>
      </ng-template>
    </p-treeTable>

  </form>


  <p-dialog *ngIf="selectedNode" header="Edit Text Definition of {{selectedNode.data.name}}" [(visible)]="textDefinitionDialogOpen" [modal]="true" [responsive]="true" [width]="350" [minWidth]="200" [minY]="70">
    <textarea pInputTextarea [(ngModel)]="selectedNode.data.text"></textarea>
  </p-dialog>

  <p-dialog *ngIf="selectedNode" header="Change Datatype for {{selectedNode.data.name}}" [(visible)]="changeDTDialogOpen" [modal]="true" [responsive]="true" [width]="350" [minWidth]="200" [minY]="70">
    <p-dropdown [options]="datatypeOptions" [(ngModel)]="selectedNode.data.displayData.datatype.id" (onChange)="onDatatypeChangeForDialog(selectedNode)" appendTo="body" [style]="{'width':'100%'}">
      <ng-template let-option pTemplate="body">
        <div class="ui-helper-clearfix" style="position: relative;height: 25px;">
          <display-ref *ngIf="option.value" [elm]="getDatatypeElm(option.value)"></display-ref>
        </div>
      </ng-template>
    </p-dropdown>
  </p-dialog>

  <p-dialog *ngIf="selectedNode && selectedSingleCode" header="Edit SingleCode for {{selectedNode.data.name}}" [(visible)]="singleCodeDialogOpen" [modal]="true" [responsive]="true" [width]="600" [minWidth]="200" [minY]="70">
    <div class="ui-g ui-fluid">
      <div class="ui-g-12 ui-md-4">
        <label>Code: </label>
      </div>
      <div class="ui-g-12 ui-md-8">
        <input [(ngModel)]="selectedSingleCode.newSingleCode" type="text" style="width:45%;border-width:0px 0px 1px 0px"/>
      </div>
    </div>

    <div class="ui-g ui-fluid">
      <div class="ui-g-12 ui-md-4">
        <label>Code System: </label>
      </div>
      <div class="ui-g-12 ui-md-8">
        <input [(ngModel)]="selectedSingleCode.newSingleCodeSystem" type="text" style="width:45%;border-width:0px 0px 1px 0px"/>
      </div>
    </div>

    <button pButton style="float: right" type="button"  class="blue-btn" icon="fa-check" label="Submit" (click)="submitNewSingleCode(selectedNode, selectedSingleCode)" [disabled]="selectedSingleCode.newSingleCode === '' || selectedSingleCode.newSingleCodeSystem === ''"></button>
  </p-dialog>

  <p-dialog *ngIf="selectedNode && selectedConstantValue" header="Edit Constant Value for {{selectedNode.data.name}}" [(visible)]="constantValueDialogOpen" [modal]="true" [responsive]="true" [width]="600" [minWidth]="200" [minY]="70">
    <input [(ngModel)]="selectedConstantValue.newConstantValue" type="text" style="width:90%;border-width:0px 0px 1px 0px"/>
    <button pButton style="float: right" type="button"  class="blue-btn" icon="fa-check" label="Submit" (click)="submitNewConstantValue(selectedNode, selectedConstantValue)" [disabled]="selectedConstantValue.newConstantValue === ''"></button>
  </p-dialog>

  <p-dialog *ngIf="selectedNode && selectedVS" header="Edit Valueset binding for {{selectedNode.data.name}}" [(visible)]="valuesetDialogOpen" [modal]="true" [responsive]="true" [width]="600" [minWidth]="200" [minY]="70">
    <div class="ui-g ui-fluid">
      <div class="ui-g-12 ui-md-4">
        <label>Binding Identifier: </label>
      </div>
      <div class="ui-g-12 ui-md-8">
        <p-dropdown [options]="valuesetOptions" [(ngModel)]="selectedVS.newvalue.valuesetId" appendTo="body" [style]="{'width':'150px'}" filter="true">
          <ng-template let-option pTemplate="body">
            <div class="ui-helper-clearfix" style="position: relative;height: 25px;">
              <display-ref *ngIf="option.value" [elm]="getValueSetElm(option.value)"></display-ref>
              <span *ngIf="!option.value">{{option.label}}</span>
            </div>
          </ng-template>
        </p-dropdown>
      </div>
    </div>

    <div class="ui-g ui-fluid">
      <div class="ui-g-12 ui-md-4">
        <label>Strength: </label>
      </div>
      <div class="ui-g-12 ui-md-8">
        <p-dropdown [options]="valuesetStrengthOptions" [(ngModel)]="selectedVS.newvalue.strength" appendTo="body" [style]="{'width':'150px'}">
        </p-dropdown>
      </div>
    </div>

    <div class="ui-g ui-fluid" *ngIf="selectedNode.data.displayData.valueSetLocationOptions">
      <div class="ui-g-12 ui-md-4">
        <label>Valueset Location: </label>
      </div>
      <div class="ui-g-12 ui-md-8">
        <p-dropdown [options]="selectedNode.data.displayData.valueSetLocationOptions" [(ngModel)]="selectedVS.newvalue.valuesetLocations" appendTo="body" [style]="{'width':'150px'}">
        </p-dropdown>
      </div>
    </div>

    <button pButton style="float: right" type="button"  class="blue-btn" icon="fa-check" label="Submit" (click)="submitNewValueSet(selectedNode, selectedVS)" [disabled]="!selectedVS.newvalue.valuesetId"></button>
  </p-dialog>


  <p-dialog *ngIf="selectedNode" header="Edit Predicate of {{selectedNode.data.name}}" [(visible)]="preciateEditorOpen" [modal]="true" [responsive]="true" [width]="1800" [minWidth]="1200" [minY]="70">
    <form #cpForm="ngForm">
      <div class="ui-g ui-fluid">
        <div class="ui-g-12 ui-md-2">
          <label>Editor Type: </label>
        </div>
        <div class="ui-g-12 ui-md-10">
          <p-selectButton name="type" [options]="constraintTypes" [(ngModel)]="selectedPredicate.type" (onChange)="changeType()"></p-selectButton>
        </div>
      </div>

      <div *ngIf="selectedPredicate.type && selectedPredicate.type ==='ASSERTION'">
        <div class="ui-g ui-fluid">
          <div class="ui-g-12 ui-md-2">
            <label>Assertion Level: </label>
          </div>
          <div class="ui-g-12 ui-md-10">
            <p-dropdown id="assertionMode" name="assertionMode" required #assertionMode="ngModel" [autoWidth]="false" [options]="assertionModes" [group]="true" [(ngModel)]="selectedPredicate.assertion.mode" (onChange)="changeAssertionMode()"></p-dropdown>
            <div *ngIf="assertionMode.invalid && (assertionMode.dirty || assertionMode.touched)" class="alert alert-danger">
              <div *ngIf="assertionMode.errors.required">
                Assertion Type is required.
              </div>
            </div>
          </div>
        </div>
      </div>

      <edit-free-constraint *ngIf="selectedPredicate.type === 'FREE'" [constraint]="selectedPredicate"></edit-free-constraint>
      <edit-simple-constraint *ngIf="selectedPredicate.assertion && selectedPredicate.assertion.mode === 'SIMPLE'" [constraint]="selectedPredicate.assertion" [idMap]="idMap" [treeData]="treeData" [groupName]="'rootSimple'"></edit-simple-constraint>
      <edit-complex-constraint *ngIf="selectedPredicate.assertion && selectedPredicate.assertion.mode !== 'SIMPLE'" [constraint]="selectedPredicate.assertion" [idMap]="idMap" [treeData]="treeData" [groupName]="'root'"></edit-complex-constraint>

      <button pButton style="float: right" type="button"  class="blue-btn" icon="fa-check" label="Submit" (click)="submitCP()"></button>
    </form>
  </p-dialog>

  <p-dialog *ngIf="selectedNode && selectedComment" header="Edit Comment Value for {{selectedNode.data.name}}" [(visible)]="commentDialogOpen" [modal]="true" [responsive]="true" [width]="600" [minWidth]="200" [minY]="70">
    <input [(ngModel)]="selectedComment.newComment.description" type="text" style="width:90%;border-width:0px 0px 1px 0px"/>
    <button pButton style="float: right" type="button"  class="blue-btn" icon="fa-check" label="Submit" (click)="submitNewComment(selectedNode, selectedComment)" [disabled]="selectedComment.newComment.description === ''"></button>
  </p-dialog>

</div>
